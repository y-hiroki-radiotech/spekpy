# SpekPy プロジェクトの詳細解説

このプロジェクトは、X線管のスペクトルをモデル化するためのPythonツールキット「SpekPy」の開発、配布、および学習用資料一式を含んでいます。物理モデルに基づいたX線スペクトルの生成、フィルタリング、線量評価、ビーム品質の計算など、医用物理学における様々なタスクをサポートします。

以下に、各ディレクトリとその内容について詳しく解説します。

---

## `spekpy_release/` - 配布用パッケージ

このディレクトリは、PyPIで配布されている`spekpy`パッケージの本体です。ユーザーが`pip install spekpy`でインストールする際のソースとなります。

- **`setup.py`**: Pythonパッケージのインストールと配布を設定するためのスクリプトです。
- **`spekpy/`**: パッケージのコアとなるソースコードが格納されています。
    - `SpekPy.py`: メインクラス`Spek`を定義しています。スペクトルの生成、フィルタリング、各種物理量の計算（HVL、線量、平均エネルギーなど）を行うためのインターフェースを提供します。
    - `SpekModel.py`: X線スペクトルを生成するための物理モデル（`kqp`, `casim`など）の計算ロジックを実装しています。
    - `SpekTools.py`: 物理量（HVL、線量など）をスペクトルデータから計算するための補助関数群です。
    - `DataTables.py`, `SpekConstants.py`: 物理計算に必要な定数や減弱係数などのデータテーブルを管理します。
    - `data/`: 物質定義ファイル（`.comp`）、吸収係数テーブルなどが格納されており、物理計算の基礎となります。
- **`examples/`**: SpekPyの基本的な使い方を学ぶためのサンプルPythonスクリプト集です。フィルタリング、プロット、状態の保存・読み込みなど、具体的な使用例が示されています。
- **`tests/`**: ソフトウェアの正確性と信頼性を保証するためのテストコードが含まれています。特定の条件下での計算結果を既知の値と比較検証します。
- **`ReadMe.md`**: パッケージのインストール方法、ドキュメントへのリンク、引用情報などが記載されています。

---

## 番号付きチュートリアルディレクトリ (`1_...` 〜 `10_...`)

これらのディレクトリは、関連書籍の各章に対応しており、SpekPyを用いた具体的な物理計算やシミュレーションの例題を提供します。各ディレクトリには、目的を説明する`ReadMe.md`、実行可能なPythonスクリプト（`.py`）、そして多くの場合、その実行結果（プロットなど）を含むHTMLファイル（`.html`）が含まれています。

- **`1_Introduction/`**: `demo.py`で、100kVのX線スペクトルを生成し、アルミニウムフィルタを適用後、HVL（半価層）、カーマ、フルエンスを計算し、スペクトルをプロットする基本的な流れを実演します。

- **`2_Basics of x-ray tubes/`**: `heel_effect.py`を用いて、陽極角度（アノードアングル）がX線強度分布に与える影響（ヒール効果）をシミュレーションし、可視化します。

- **`3_X-ray production/`**: `percent_char.py`で、管電圧を変化させた際に、総フルエンスに占める特性X線の割合がどのように変わるかを計算し、プロットします。

- **`4_Basic dosimetry and beam-quality characterization/`**: `mean_coeff.py`を使い、フルエンス、エネルギーフルエンス、カーマで重み付けした平均エネルギーや平均減弱係数を計算し、ビーム品質評価の方法を示します。

- **`5_A review of analytical model of the x-ray spectrum/`**: `classical_approx.py`で、古典的なKramersモデルとSpekPyのより高度な物理モデル（`kqp`）によるスペクトル予測を比較し、モデルの妥当性を検討します。

- **`6_An analytical model in detail/`**: `physics_models.py`で、SpekPyに実装されている複数の物理モデル（`diff`, `uni`, `sim`, `kqp`）の違いが、生成されるスペクトルとHVLにどのような影響を与えるかを示します。

- **`7_Overview on Monte Carlo modelling/`**: モンテカルロシミュレーションコード（EGSnrc/BEAMnrc）を用いてX線管をモデル化するためのサンプル入力ファイルを提供します。SpekPyの解析モデルとモンテカルロ法の結果を比較するためのものです。

- **`8_Predicting and matching half-value layers/`**: `beams_bipm.py`などのスクリプトで、BIPMやNIST、ISOなどの国際標準で定められた基準X線ビームのHVLをSpekPyで再現し、その精度を検証します。

- **`9_Kilovoltage x-ray beam dosimetry/`**: `BSFw.py`で、与えられたスペクトル、照射野サイズ、SSD（線源皮膚間距離）に対して後方散乱係数（BSF）を計算する方法を示します。

- **`10_Optimizing the tube potential/`**: `metrics.py`と関連スクリプトで、特定の撮像タスク（例：腎臓と脂肪組織の識別）において、線量正規化CNR（CNRD）などの評価指標を最大化する最適な管電圧を探索する方法を実演します。

---

## `paper_and_book/` - 関連学術資料

SpekPyの理論的背景、アルゴリズム、検証結果について詳述した学術論文や書籍のPDFが格納されています。このツールキットを研究目的で使用する際の重要な参考文献となります。

## paper_and_book/`内のファイルの中身は基本的に参照しなくても構いません。
## spekpyの簡単な使い方のまとめは`spekpy_wiki.pdf`にあります。必要に応じて参照してください。

# このプロジェクトの目標
## Spekpyを用いて、臨床で使われている条件を元に、entrance surface air kerma（ESAK）を計算し、線量評価を行うことです。
## また、X線管のスペクトルをモデル化し、必要なパラメータを入力して、その結果をスペクトルの可視化と線量（空気カーマ）を表示したいです。
## 入力パラメータとして必要なものは、管電圧（kVp）、管電流（mA）、照射時間（s）、フィルタ材質と厚さ、アノード角度などです。
## 最終的にはstreamlitを使ってwebアプリケーション化を行い、ユーザーが簡単にスペクトルの計算と線量評価を行えるようにすることを目指します。
## 結果の保存方法は、CSVファイルやJSON形式での保存を検討しています。これにより、後で結果を再利用したり、他のツールと連携することが容易になります。

## pythonの管理は、`uv`を使用して行います。
## 必要なライブラリやspekpyは`uv install`でインストールしてください。

## 最終的な記録は、装置名とプロトコール名を入れられるようにしてください。
